DROP PROCEDURE IF EXISTS UpdateBestsellers;

DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
	  DECLARE RENTS_NUMBER, DAYS, BK_ID INT;
    DECLARE RENTS_PER_MONTH DECIMAL(5,2);
    DECLARE FINISHED INT DEFAULT 0;
    DECLARE ALL_BOOKS CURSOR FOR SELECT BOOK_ID FROM BOOKS;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
    OPEN ALL_BOOKS;
    WHILE (FINISHED = 0) DO
		FETCH ALL_BOOKS INTO BK_ID;
        IF (FINISHED = 0) THEN
			    SELECT count(*)
			    FROM RENTS
			    WHERE BOOK_ID = BK_ID
			    INTO RENTS_NUMBER;
          SELECT DATEDIFF(MAX(RENT_DATE), MIN(RENT_DATE)) + 1
          FROM RENTS
          WHERE  BOOK_ID = BK_ID
          INTO DAYS;
          SET RENTS_PER_MONTH = RENTS_NUMBER / DAYS * 30;

          IF RENTS_PER_MONTH > 2 THEN
				    UPDATE BOOKS SET BESTSELLER = TRUE
            WHERE BOOK_ID = BK_ID;
			    ELSE
			      UPDATE BOOKS SET BESTSELLER = FALSE
            WHERE BOOK_ID = BK_ID;
			    END IF;
          COMMIT;
		    END IF;
	  END WHILE;
  CLOSE ALL_BOOKS;
END $$

DELIMITER ;
